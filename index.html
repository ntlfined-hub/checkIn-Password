<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Check In Fin-ed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --card-radius:1.5rem; --input-radius:.9rem; --input-padding-y:.9rem; --input-padding-x:1rem; --input-font-size:1.05rem; }
    body{ box-sizing:border-box; font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif }
    .glass{ background:rgba(255,255,255,.08); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.12) }
    .card{ border-radius:var(--card-radius) }
    .input{ width:100%; background:rgba(255,255,255,.06); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.15); color:#fff;
            padding:var(--input-padding-y) var(--input-padding-x); border-radius:var(--input-radius); font-size:var(--input-font-size) }
    .input:focus{ background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.3); box-shadow:0 0 0 3px rgba(255,255,255,.08); outline:none }
    select.input option{ color:#111; background:#fff }
    .input[type="date"], .input[type="time"]{ -webkit-appearance:none; appearance:none; line-height:1.65 }
    .input[type="date"]::-webkit-calendar-picker-indicator, .input[type="time"]::-webkit-calendar-picker-indicator{ padding-right:.5rem; filter:invert(1) opacity(.85) }
    .btn{ background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); transition:.2s; border-radius:var(--input-radius) }
    .btn:hover{ background:rgba(255,255,255,.18); transform:translateY(-1px) }
    .btn-cta{ background:linear-gradient(135deg,#10b981,#16a34a); border:0; box-shadow:0 12px 24px rgba(16,185,129,.25) }
    .btn-cta:hover{ transform:translateY(-1.5px) scale(1.01); box-shadow:0 16px 30px rgba(16,185,129,.32) }
    .pill{ background:rgba(255,255,255,.1); border-radius:calc(var(--input-radius) + .4rem) }
    .chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18) }
    .mini-btn{ background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); border-radius:.7rem }
    .tab-btn{ border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06) }
    .tab-btn[aria-selected="true"]{ background:rgba(16,185,129,.18); border-color:rgba(16,185,129,.4) }
    .tab-panel{ display:none } .tab-panel.active{ display:block }
    .btn-equal{ padding:var(--input-padding-y) var(--input-padding-x); border-radius:var(--input-radius) }
    .row-card{ border-radius:1rem; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1) }
    body.auth-locked { overflow: hidden; }
    @keyframes shake {10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
    .shake { animation: shake .35s linear both; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-gray-900 to-zinc-900 text-white auth-locked">

  <!-- AUTH GATE -->
  <div id="authGate" class="fixed inset-0 z-[60] flex items-center justify-center p-6">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
    <div id="authCard" class="relative glass card w-full max-w-sm p-6">
      <div class="text-center mb-4">
        <div class="inline-flex items-center justify-center w-14 h-14 rounded-xl bg-white/10 border border-white/20 mb-3">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.567 3-3.5S13.657 4 12 4 9 5.567 9 7.5 10.343 11 12 11zM19 21a7 7 0 00-14 0h14z"/>
          </svg>
        </div>
        <h2 class="text-xl font-semibold">‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
        <p class="text-white/70 text-sm mt-1">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
      </div>
      <label class="block text-sm font-medium mb-2">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
      <div class="flex gap-2">
        <input id="authInput" type="password" class="input flex-1" placeholder="‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô"/>
        <button id="authToggle" type="button" class="btn px-3">‡πÅ‡∏™‡∏î‡∏á</button>
      </div>
      <p id="authError" class="text-red-300 text-sm mt-2 hidden">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á</p>
      <button id="authBtn" type="button" class="btn btn-cta w-full py-3 font-semibold mt-4">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      <p class="text-xs text-white/60 mt-3">* ‡∏à‡∏∞‡∏à‡∏≥‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏õ‡∏•‡∏î‡∏•‡πá‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡πÅ‡∏ó‡πá‡∏ö‡∏ô‡∏µ‡πâ‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÅ‡∏ó‡πá‡∏ö</p>
    </div>
  </div>

  <!-- background glow -->
  <div class="fixed inset-0 pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 rounded-full blur-3xl bg-white/10"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 rounded-full blur-3xl bg-white/10"></div>
  </div>

  <div class="relative z-10 container mx-auto max-w-4xl px-6 py-10">
    <!-- header -->
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-white/10 border border-white/20 mb-5">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
        </svg>
      </div>
      <h1 class="text-3xl font-bold tracking-tight">Check In Fin-ed</h1>
    </div>

    <!-- Tabs -->
    <div class="glass card p-2 mb-6">
      <div role="tablist" class="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <button id="tab-1" type="button" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="true">Check In</button>
        <button id="tab-2" type="button" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="false">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</button>
        <button id="tab-3" type="button" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="false">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤ Check-in</button>
      </div>
    </div>

    <!-- ===== TAB 1: ‡∏ü‡∏≠‡∏£‡πå‡∏° (‡∏Ñ‡∏á‡πÄ‡∏î‡∏¥‡∏°) ===== -->
    <section id="panel-1" class="tab-panel active">
      <div class="glass card p-6 mb-8">
        <form id="checkinForm" class="space-y-6">
          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-2">‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</label>
              <select id="nameSelect" class="input" required>
                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</option>
                <option>Tow</option><option>Kwan</option><option>Noi</option><option>Ray</option><option>Cap</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
              <input id="dateInput" type="date" class="input" required>
              <p class="text-xs text-white/70 mt-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ß‡∏±‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ</p>
            </div>
          </div>

          <div>
            <label class="block text-sm font-semibold mb-2">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>
            <div class="flex pill p-1">
              <button id="fullBtn"  type="button" class="flex-1 py-2 rounded-xl bg-white/20 font-medium">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô</button>
              <button id="splitBtn" type="button" class="flex-1 py-2 rounded-xl text-white/90 font-medium">‡πÅ‡∏¢‡∏Å AM/PM</button>
            </div>
          </div>

          <div id="fullBox">
            <label class="block text-sm font-semibold mb-2">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)</label>
            <input id="fullLocation" type="text" value="Ari" class="input" placeholder="‡πÄ‡∏ä‡πà‡∏ô Ari">
            <p class="text-xs text-white/70 mt-2">* ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏ï‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ô</p>
          </div>

          <div id="splitBox" class="hidden space-y-4">
            <div>
              <label class="block text-sm font-semibold mb-2">üåÖ AM</label>
              <input id="amLocation" type="text" value="Ari" class="input" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ä‡πâ‡∏≤">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-2">üåÜ PM</label>
              <input id="pmLocation" type="text" value="Ari" class="input" placeholder="‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏á‡∏ö‡πà‡∏≤‡∏¢">
            </div>
          </div>

          <div>
            <div class="flex items-center gap-2 mb-2">
              <span class="text-sm font-semibold">‡∏ï‡∏±‡∏ß‡∏ä‡πà‡∏ß‡∏¢‡∏à‡∏≤‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
              <span id="suggestLoading" class="text-xs text-white/70 hidden">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‚Ä¶</span>
            </div>
            <div id="suggestWrap" class="grid grid-cols-1 gap-2"></div>
            <p id="suggestEmpty" class="text-xs text-white/60 hidden">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏Ñ‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</p>
          </div>

          <button id="checkinBtn" type="submit" class="btn btn-cta w-full py-3 font-semibold flex items-center justify-center gap-2">
            <span>Check In</span>
          </button>
        </form>
      </div>

      <!-- Bulk -->
      <div class="glass card p-6 mb-8">
        <h2 class="text-lg font-semibold mb-2">‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡∏•‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (‡πÇ‡∏´‡∏°‡∏î‡∏Ç‡∏µ‡πâ‡πÄ‡∏Å‡∏µ‡∏¢‡∏à)</h2>
        <p class="text-white/70 text-sm mb-4">‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‚Äú‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‚Äù ‡πÅ‡∏•‡∏∞ ‚Äú‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤/‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‚Äù ‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏î‡πâ‡∏≤‡∏ô‡∏ö‡∏ô</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
          <button id="bulkThisWeek" type="button" class="btn px-4 py-3 font-semibold">‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ</button>
          <button id="bulkNextWeek" type="button" class="btn px-4 py-3 font-semibold">‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
          <div><label class="block text-sm font-semibold mb-2">‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="rangeStart" type="date" class="input"></div>
          <div><label class="block text-sm font-semibold mb-2">‡∏ñ‡∏∂‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input id="rangeEnd" type="date" class="input"></div>
        </div>
        <div class="mt-3"><button id="bulkRange" type="button" class="btn px-5 py-3 font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</button></div>
        <p class="text-xs text-white/70 mt-3">* ‡πÇ‡∏´‡∏°‡∏î ‡∏à‚Äì‡∏® ‡∏à‡∏∞‡∏Ç‡πâ‡∏≤‡∏°‡πÄ‡∏™‡∏≤‡∏£‡πå‚Äì‡∏≠‡∏≤‡∏ó‡∏¥‡∏ï‡∏¢‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ | ‡πÇ‡∏´‡∏°‡∏î‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏±‡πâ‡∏ô</p>
      </div>
    </section>

    <!-- TAB 2 -->
    <section id="panel-2" class="tab-panel">
      <div class="glass card p-6">
        <h2 class="text-xl font-semibold mb-4">‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</h2>
        <div class="w-full max-w-md">
          <select id="viewName" class="input w-full mb-3">
            <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</option>
            <option>Tow</option><option>Kwan</option><option>Noi</option><option>Ray</option><option>Cap</option>
          </select>
          <button id="viewBtn" type="button" class="btn btn-equal w-full font-semibold">‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á</button>
        </div>
        <div id="scheduleWrap" class="hidden mt-6">
          <div id="scheduleList" class="space-y-3"></div>
        </div>
      </div>
    </section>

    <!-- TAB 3 -->
    <section id="panel-3" class="tab-panel">
      <div class="glass card p-6">
        <h2 class="text-xl font-semibold mb-4">‡∏™‡πà‡∏á Check-in ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå</h2>
        <div class="grid lg:grid-cols-2 gap-6">
          <div class="rounded-2xl p-5 bg-white/5 border border-white/10">
            <h3 class="font-semibold mb-3">‡∏™‡πà‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ</h3>
            <div class="grid sm:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-semibold mb-2">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                <input id="sendDateInput" type="date" class="input">
              </div>
              <div class="sm:pt-7">
                <button id="sendNowBtn" type="button" class="btn w-full py-3 font-semibold">‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏î‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î</button>
              </div>
            </div>
          </div>

          <div class="rounded-2xl p-5 bg-white/5 border border-white/10">
            <h3 class="font-semibold mb-3">‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</h3>
            <div class="grid sm:grid-cols-3 gap-3 items-end mb-4">
              <label class="flex items-center gap-2 sm:col-span-1">
                <input type="checkbox" id="schedEnabled" class="accent-emerald-400">
                <span>‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</span>
              </label>
              <div class="sm:col-span-2">
                <label class="block text-sm font-semibold mb-2">‡πÄ‡∏ß‡∏•‡∏≤ (HH:mm)</label>
                <input type="time" id="schedTime" class="input" value="08:30">
              </div>
            </div>

            <div class="mb-3">
              <div class="text-sm mb-2 font-medium">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡πÉ‡∏ô‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå</div>
              <div id="weekdayWrap" class="grid grid-cols-7 gap-1 text-center"></div>
            </div>

            <label class="flex items-center gap-2 mb-4">
              <input type="checkbox" id="schedSkipHolidays" class="accent-emerald-400" checked>
              <span class="text-sm">‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡∏´‡∏¢‡∏∏‡∏î (‡∏ä‡∏µ‡∏ï Holidays)</span>
            </label>

            <div class="flex flex-col sm:flex-row gap-3">
              <button id="saveSchedBtn" type="button" class="btn flex-1 py-3 font-semibold">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á</button>
              <button id="reloadSchedBtn" type="button" class="btn sm:w-32 py-3 font-semibold">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
            </div>

            <div id="schedStatus" class="text-xs text-white/70 mt-3"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- status & popup -->
    <div id="status" class="hidden mt-6 p-4 rounded-2xl"></div>
    <div id="popup" class="hidden fixed inset-0 z-50 items-center justify-center p-6">
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="relative glass card p-6 max-w-sm w-full text-center">
        <div class="w-14 h-14 rounded-2xl bg-green-500/20 mx-auto mb-4 flex items-center justify-center">
          <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
          </svg>
        </div>
        <h3 class="text-xl font-semibold mb-2">‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</h3>
        <p id="popupMsg" class="text-white/90 mb-4"></p>
        <button id="popupOk" type="button" class="btn w-full py-2 font-semibold">‡∏ï‡∏Å‡∏•‡∏á</button>
      </div>
    </div>
  </div>

  <script>
  (function(){
    /* ===== SAFE HELPERS (ES5) ===== */
    function byId(id){ return document.getElementById(id); }
    function text(el, t){ if(el) el.textContent = t; }
    function show(el){ if(el){ el.classList.remove('hidden'); } }
    function hide(el){ if(el){ el.classList.add('hidden'); } }
    function addClass(el, c){ if(el){ el.classList.add(c); } }
    function removeClass(el, c){ if(el){ el.classList.remove(c); } }

    /* ===== AUTH ===== */
    var PASSWORD = '1150';
    var AUTH_KEY = 'auth_ok';

    function unlockApp(silent){
      document.body.classList.remove('auth-locked');
      var gate = byId('authGate');
      if(gate && gate.parentNode){ gate.parentNode.removeChild(gate); } // ‡∏ñ‡∏≠‡∏î overlay ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ‡πÄ‡∏•‡∏¢
      try{ sessionStorage.setItem(AUTH_KEY,'1'); }catch(e){}
      if(!silent){
        var h1 = document.querySelector('h1');
        if(h1 && h1.scrollIntoView){ h1.scrollIntoView({behavior:'smooth', block:'start'}); }
      }
    }
    function shakeCard(){
      var card = byId('authCard');
      var err = byId('authError');
      if(err) err.classList.remove('hidden');
      if(!card) return;
      card.classList.remove('shake'); // reflow
      void card.offsetWidth;
      card.classList.add('shake');
    }
    function tryAuth(){
      var input = byId('authInput');
      var v = (input && input.value) ? input.value.replace(/^\s+|\s+$/g,'') : '';
      if(v === PASSWORD){
        if(byId('authError')) addClass(byId('authError'),'hidden');
        unlockApp(false);
      }else{
        shakeCard();
      }
    }

    // bind early events (‡∏ñ‡πâ‡∏≤ script ‡∏°‡∏µ syntax error ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏ô‡∏µ‡πâ ‡∏õ‡∏∏‡πà‡∏°‡∏à‡∏∞‡∏¢‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ syntax ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÉ‡∏´‡∏°‡πà‡πÅ‡∏•‡πâ‡∏ß)
    var btnLogin = byId('authBtn');
    if(btnLogin){ btnLogin.addEventListener('click', tryAuth); }
    var inputPwd = byId('authInput');
    if(inputPwd){
      inputPwd.addEventListener('keydown', function(e){
        if(e && e.key === 'Enter'){ e.preventDefault(); tryAuth(); }
      });
    }
    var btnToggle = byId('authToggle');
    if(btnToggle){
      btnToggle.addEventListener('click', function(){
        var i = byId('authInput');
        if(!i) return;
        i.type = (i.type === 'password') ? 'text' : 'password';
        text(byId('authToggle'), i.type === 'password' ? '‡πÅ‡∏™‡∏î‡∏á' : '‡∏ã‡πà‡∏≠‡∏ô');
        try{ i.focus(); i.selectionStart = i.value.length; i.selectionEnd = i.value.length; }catch(e){}
      });
    }
    // init focus + remember
    try{
      if(sessionStorage.getItem(AUTH_KEY) === '1'){ unlockApp(true); }
      else{ setTimeout(function(){ var el = byId('authInput'); if(el) el.focus(); }, 30); }
    }catch(e){}

    /* ===== POPUP ===== */
    function openPopup(msg){
      text(byId('popupMsg'), msg || '');
      var p = byId('popup'); if(!p) return;
      p.classList.remove('hidden'); p.classList.add('flex');
    }
    function closePopup(){
      var p = byId('popup'); if(!p) return;
      p.classList.add('hidden'); p.classList.remove('flex');
    }
    var popupOk = byId('popupOk');
    if(popupOk){ popupOk.addEventListener('click', closePopup); }

    /* ===== CONFIG & UTILS ===== */
    var APP_SCRIPT_WEBAPP_URL='https://script.google.com/macros/s/AKfycbxKmlulJgGnv8pUqbbOYlK5mRn6jZ_DdQQCKoJ3dExHWl62mDOPhDR5usWbSpC38gzH/exec';
    function toLocalISO(d){
      var y=d.getFullYear(), m=('0'+(d.getMonth()+1)).slice(-2), da=('0'+d.getDate()).slice(-2);
      return y+'-'+m+'-'+da;
    }
    function getWeekRange(offset){
      offset = offset||0;
      var now=new Date(); now.setHours(0,0,0,0);
      var diffToMon=(now.getDay()===0?-6:1-now.getDay())+offset*7;
      var mon=new Date(now); mon.setDate(now.getDate()+diffToMon);
      var fri=new Date(mon); fri.setDate(mon.getDate()+4);
      return {start:toLocalISO(mon), end:toLocalISO(fri)};
    }
    function toast(msg,type){
      type = type||'info';
      var el=byId('status'); if(!el) return;
      el.className='mt-6 p-4 rounded-2xl '+(type==='error'?'bg-red-500/20 border border-red-500/40':'bg-white/10 border border-white/20');
      el.textContent=msg||''; el.classList.remove('hidden'); setTimeout(function(){ el.classList.add('hidden'); },4500);
    }
    function setBtnLoading(btn,loading,done,label){
      if(!btn) return;
      done = done||'‡πÄ‡∏™‡∏£‡πá‡∏à'; label = label||'‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ó‡∏≥‡∏á‡∏≤‡∏ô...';
      if(loading){
        btn.disabled=true; btn.setAttribute('data-prev', btn.innerHTML);
        btn.innerHTML='<span class="inline-flex items-center gap-2"><svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>'+label+'</span>';
      } else {
        btn.disabled=false; btn.innerHTML=btn.getAttribute('data-prev')||done;
      }
    }

    /* ===== Tabs ===== */
    var tabs=[{btn:'tab-1',panel:'panel-1'},{btn:'tab-2',panel:'panel-2'},{btn:'tab-3',panel:'panel-3'}];
    function activateTab(i){
      for(var k=0;k<tabs.length;k++){
        var t=tabs[k];
        var b=byId(t.btn), p=byId(t.panel);
        if(b) b.setAttribute('aria-selected', i===k?'true':'false');
        if(p){ if(i===k) addClass(p,'active'); else removeClass(p,'active'); }
      }
      try{ localStorage.setItem('activeTab', String(i)); }catch(e){}
    }
    for(var iTab=0;iTab<tabs.length;iTab++){
      (function(idx){
        var b=byId(tabs[idx].btn);
        if(b) b.addEventListener('click', function(){ activateTab(idx); });
      })(iTab);
    }
    try{
      var savedTab = Number(localStorage.getItem('activeTab'));
      if(!isNaN(savedTab)) activateTab(savedTab);
    }catch(e){}

    /* ===== UI init ===== */
    var today = toLocalISO(new Date());
    var dateInput = byId('dateInput'); if(dateInput){ dateInput.min=today; dateInput.value=today; }
    var rs=byId('rangeStart'), re=byId('rangeEnd'); if(rs){ rs.min=today; } if(re){ re.min=today; }
    var sendDateInput = byId('sendDateInput'); if(sendDateInput){ sendDateInput.min=today; sendDateInput.value=today; }

    /* ===== Toggle AM/PM ===== */
    var splitMode=false;
    var fullBtn=byId('fullBtn'), splitBtn=byId('splitBtn');
    var fullBox=byId('fullBox'),  splitBox=byId('splitBox');
    if(fullBtn) fullBtn.addEventListener('click', function(){
      splitMode=false; if(fullBtn) addClass(fullBtn,'bg-white/20'); if(splitBtn) removeClass(splitBtn,'bg-white/20');
      show(fullBox); hide(splitBox);
    });
    if(splitBtn) splitBtn.addEventListener('click', function(){
      splitMode=true; if(splitBtn) addClass(splitBtn,'bg-white/20'); if(fullBtn) removeClass(fullBtn,'bg-white/20');
      show(splitBox); hide(fullBox);
    });

    /* ===== API helper ===== */
    function callAPI(action,payload,cb){
      var fd=new FormData();
      fd.append('action', action);
      try{ fd.append('payload', JSON.stringify(payload||{})); }catch(e){ fd.append('payload','{}'); }
      fetch(APP_SCRIPT_WEBAPP_URL,{method:'POST',body:fd})
        .then(function(res){ return res.text(); })
        .then(function(t){ var r; try{ r=JSON.parse(t); }catch(e){ r={ok:false,error:'Invalid JSON',raw:t}; } cb(r); })
        .catch(function(){ cb({ok:false,error:'NETWORK'}); });
    }

    /* ===== Suggestions ===== */
    var suggestWrap=byId('suggestWrap'), suggestEmpty=byId('suggestEmpty'), suggestLoading=byId('suggestLoading');
    function parsePart(s){
      s=s||''; var m=/(.*)\s+\((AM|PM)\)$/i.exec(s); return m ? [m[1].replace(/\s+$/,''), '('+m[2].toUpperCase()+')'] : [s,''];
    }
    function escapeHTML(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function renderSuggestItem(it){
      var p = parsePart(it.location||''); var loc=p[0], part=p[1]; var names=(it.names||[]).join(' ');
      var partSpan = part ? '<span class="text-xs text-white/70">'+part+'</span>' : '';
      return ''+
      '<div class="chip rounded-xl p-3">' +
        '<div class="flex items-center justify-between gap-3">' +
          '<div>' +
            '<div class="font-medium">'+loc+' '+partSpan+'</div>' +
            '<div class="text-xs text-white/70">‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô ('+(it.count||0)+'): '+names+'</div>' +
          '</div>' +
          '<div class="flex gap-2">' +
            '<button type="button" class="mini-btn text-xs px-2 py-1" data-action="sugg" data-mode="both" data-loc="'+escapeHTML(loc)+'">‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô</button>' +
            '<button type="button" class="mini-btn text-xs px-2 py-1" data-action="sugg" data-mode="am" data-loc="'+escapeHTML(loc)+'">AM</button>' +
            '<button type="button" class="mini-btn text-xs px-2 py-1" data-action="sugg" data-mode="pm" data-loc="'+escapeHTML(loc)+'">PM</button>' +
          '</div>' +
        '</div>' +
      '</div>';
    }
    function refreshSuggestions(){
      var dEl = byId('dateInput'); var nEl = byId('nameSelect');
      var date = dEl ? dEl.value : ''; var name = nEl ? (nEl.value||'').replace(/^\s+|\s+$/g,'') : '';
      if(!date) return;
      if(suggestWrap) suggestWrap.innerHTML='';
      if(suggestEmpty) addClass(suggestEmpty,'hidden');
      if(suggestLoading) removeClass(suggestLoading,'hidden');
      callAPI('suggest', {date:date, excludeName:name||''}, function(res){
        if(suggestLoading) addClass(suggestLoading,'hidden');
        if(!res.ok){
          if(suggestWrap) suggestWrap.innerHTML='<div class="text-red-300 text-sm">'+(res.error||'‡πÇ‡∏´‡∏•‡∏î‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')+'</div>';
          return;
        }
        var items = res.items||[];
        if(!items.length){
          if(suggestEmpty) removeClass(suggestEmpty,'hidden');
          return;
        }
        var html=''; for(var i=0;i<items.length;i++){ html+=renderSuggestItem(items[i]); }
        if(suggestWrap) suggestWrap.innerHTML=html;
      });
    }
    if(byId('dateInput')) byId('dateInput').addEventListener('change', refreshSuggestions);
    if(byId('nameSelect')) byId('nameSelect').addEventListener('change', refreshSuggestions);
    refreshSuggestions();

    // delegation for suggestion buttons
    if(suggestWrap){
      suggestWrap.addEventListener('click', function(ev){
        var btn = ev.target.closest ? ev.target.closest('[data-action="sugg"]') : null;
        if(!btn) return;
        var loc = btn.getAttribute('data-loc')||'';
        var mode = btn.getAttribute('data-mode')||'both';
        if(mode==='both'){
          if(!splitMode){ var fl=byId('fullLocation'); if(fl) fl.value=loc; }
          else { var am=byId('amLocation'), pm=byId('pmLocation'); if(am) am.value=loc; if(pm) pm.value=loc; }
        }else if(mode==='am'){
          splitMode=true; if(splitBtn) splitBtn.click(); var am2=byId('amLocation'); if(am2) am2.value=loc;
        }else{
          splitMode=true; if(splitBtn) splitBtn.click(); var pm2=byId('pmLocation'); if(pm2) pm2.value=loc;
        }
        toast('‡πÉ‡∏™‡πà‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà: '+loc+' ('+(mode==='both'?'‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô':mode.toUpperCase())+')');
      });
    }

    /* ===== Submit single day ===== */
    var checkinBtn = byId('checkinBtn');
    if(byId('checkinForm')) byId('checkinForm').addEventListener('submit', function(e){
      e.preventDefault();
      var name=(byId('nameSelect').value||'').replace(/^\s+|\s+$/g,'');
      var date=byId('dateInput').value;
      if(!name||!date) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô','error');
      if(date<today)    return toast('‡πÑ‡∏°‡πà‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á','error');

      var payload;
      if(!splitMode){
        var loc=(byId('fullLocation').value||'').replace(/^\s+|\s+$/g,'');
        if(!loc) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)','error');
        payload={name:name, date:date, split:false, location:loc};
      }else{
        var am=(byId('amLocation').value||'').replace(/^\s+|\s+$/g,'');
        var pm=(byId('pmLocation').value||'').replace(/^\s+|\s+$/g,'');
        if(!am||!pm) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM','error');
        payload={name:name, date:date, split:true, amLoc:am, pmLoc:pm};
      }

      setBtnLoading(checkinBtn,true,'Check In','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
      callAPI('create', payload, function(r){
        setBtnLoading(checkinBtn,false,'Check In');
        if(!r.ok) return toast(r.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
        openPopup(r.upsert ? '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢' : '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        refreshSuggestions();
      });
    });

    /* ===== Bulk ===== */
    function commonBulk(){
      var name=(byId('nameSelect').value||'').replace(/^\s+|\s+$/g,'');
      if(!name){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô','error'); return null; }
      if(!splitMode){
        var loc=(byId('fullLocation').value||'').replace(/^\s+|\s+$/g,'');
        if(!loc){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)','error'); return null; }
        return {name:name, split:false, location:loc};
      }
      var am=(byId('amLocation').value||'').replace(/^\s+|\s+$/g,'');
      var pm=(byId('pmLocation').value||'').replace(/^\s+|\s+$/g,'');
      if(!am||!pm){ toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM','error'); return null; }
      return {name:name, split:true, amLoc:am, pmLoc:pm};
    }
    var bulkThisWeekBtn=byId('bulkThisWeek'),
        bulkNextWeekBtn=byId('bulkNextWeek'),
        bulkRangeBtn=byId('bulkRange');

    if(bulkThisWeekBtn) bulkThisWeekBtn.addEventListener('click', function(){
      var base=commonBulk(); if(!base) return;
      var we=getWeekRange(0);
      var payload={}; for(var k in base){ payload[k]=base[k]; }
      payload.startDate=we.start; payload.endDate=we.end; payload.weekdaysOnly=true;
      setBtnLoading(bulkThisWeekBtn,true,'‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...');
      callAPI('bulkCreate', payload, function(r){
        setBtnLoading(bulkThisWeekBtn,false,'‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏ô‡∏µ‡πâ');
        if(!r.ok) return toast(r.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
        var msg='‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏û‡∏¥‡πà‡∏° '+r.created+' ¬∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï '+r.updated+(r.skippedPast?(' ¬∑ ‡∏Ç‡πâ‡∏≤‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á '+r.skippedPast):'');
        openPopup(msg);
      });
    });

    if(bulkNextWeekBtn) bulkNextWeekBtn.addEventListener('click', function(){
      var base=commonBulk(); if(!base) return;
      var we=getWeekRange(1);
      var payload={}; for(var k in base){ payload[k]=base[k]; }
      payload.startDate=we.start; payload.endDate=we.end; payload.weekdaysOnly=true;
      setBtnLoading(bulkNextWeekBtn,true,'‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...');
      callAPI('bulkCreate', payload, function(r){
        setBtnLoading(bulkNextWeekBtn,false,'‡∏™‡∏£‡πâ‡∏≤‡∏á ‡∏à‚Äì‡∏® ‡∏™‡∏±‡∏õ‡∏î‡∏≤‡∏´‡πå‡∏´‡∏ô‡πâ‡∏≤');
        if(!r.ok) return toast(r.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
        openPopup('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏û‡∏¥‡πà‡∏° '+r.created+' ¬∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï '+r.updated);
      });
    });

    if(bulkRangeBtn) bulkRangeBtn.addEventListener('click', function(){
      var base=commonBulk(); if(!base) return;
      var s=byId('rangeStart').value, e=byId('rangeEnd').value;
      if(!s||!e) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö','error');
      if(e<s)    return toast('‡∏ß‡∏±‡∏ô‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏ß‡∏±‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°','error');
      var payload={}; for(var k in base){ payload[k]=base[k]; }
      payload.startDate=s; payload.endDate=e; payload.weekdaysOnly=false;
      setBtnLoading(bulkRangeBtn,true,'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á...');
      callAPI('bulkCreate', payload, function(r){
        setBtnLoading(bulkRangeBtn,false,'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà');
        if(!r.ok) return toast(r.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
        openPopup('‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ‡πÄ‡∏û‡∏¥‡πà‡∏° '+r.created+' ¬∑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï '+r.updated);
      });
    });

    /* ===== Future schedule ===== */
    function formatThai(iso){
      var d=new Date(iso); var m=['‡∏°.‡∏Ñ.','‡∏Å.‡∏û.','‡∏°‡∏µ.‡∏Ñ.','‡πÄ‡∏°.‡∏¢.','‡∏û.‡∏Ñ.','‡∏°‡∏¥.‡∏¢.','‡∏Å.‡∏Ñ.','‡∏™.‡∏Ñ.','‡∏Å.‡∏¢.','‡∏ï.‡∏Ñ.','‡∏û.‡∏¢.','‡∏ò.‡∏Ñ.'];
      return d.getDate()+' '+m[d.getMonth()]+' '+(d.getFullYear()+543);
    }
    function renderItem(e){
      var detail = e.split
        ? '<div class="text-sm text-white/90">üåÖ AM: '+(e.am||'-')+'</div><div class="text-sm text-white/90">üåÜ PM: '+(e.pm||'-')+'</div>'
        : '<div class="text-sm text-white/90">'+(e.location || e.am || '-')+'</div>';
      return ''+
        '<div class="row-card p-4">'+
          '<div class="flex items-center">'+
            '<div class="flex-1 min-w-0">'+
              '<div class="font-semibold">'+formatThai(e.date)+'</div>'+detail+
            '</div>'+
            '<button type="button" class="ml-4 px-4 py-2 rounded-xl bg-white/10 hover:bg-white/20 edit-btn" data-rowid="'+e.rowId+'" data-split="'+(e.split?'1':'0')+'" data-date="'+e.date+'" data-am="'+escapeHTML(e.am||'')+'" data-pm="'+escapeHTML(e.pm||'')+'" data-loc="'+escapeHTML(e.location||'')+'">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>'+
          '</div>'+
          '<div id="edit-'+e.rowId+'" class="hidden mt-4 pt-4 border-t border-white/10"></div>'+
        '</div>';
    }
    function renderSchedule(name){
      var wrap=byId('scheduleWrap'), list=byId('scheduleList');
      if(wrap) removeClass(wrap,'hidden');
      if(list) list.innerHTML='<div class="text-white/80">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</div>';
      callAPI('listFuture',{name:name,from:today}, function(r){
        if(!byId('scheduleList')) return;
        if(!r.ok){ byId('scheduleList').innerHTML='<div class="text-red-300">'+(r.error||'‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à')+'</div>'; return; }
        var items=r.items||[];
        if(!items.length){ byId('scheduleList').innerHTML='<div class="text-white/80">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏á‡∏≤‡∏ô‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï</div>'; return; }
        var html=''; for(var i=0;i<items.length;i++){ html+=renderItem(items[i]); }
        byId('scheduleList').innerHTML=html;
      });
    }
    var viewBtn=byId('viewBtn');
    if(viewBtn) viewBtn.addEventListener('click', function(){
      var name=(byId('viewName').value||'').replace(/^\s+|\s+$/g,'');
      if(!name) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ','error');
      setBtnLoading(viewBtn,true,'‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...');
      renderSchedule(name);
      setTimeout(function(){ setBtnLoading(viewBtn,false,'‡∏î‡∏π‡∏ï‡∏≤‡∏£‡∏≤‡∏á'); }, 400); // ‡∏õ‡∏¥‡∏î‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏ö‡∏∑‡πâ‡∏≠‡∏á‡∏ï‡πâ‡∏ô
    });

    // delegation: edit / delete / save
    var scheduleList = byId('scheduleList');
    if(scheduleList){
      scheduleList.addEventListener('click', function(ev){
        var btn = ev.target.closest ? ev.target.closest('.edit-btn,[data-action="delete"],[data-action="save"],[data-action="cancel"]') : null;
        if(!btn) return;

        // open edit
        if(btn.classList.contains('edit-btn')){
          var rowId=btn.getAttribute('data-rowid');
          var isSplit=btn.getAttribute('data-split')==='1';
          var date=btn.getAttribute('data-date');
          var am=btn.getAttribute('data-am')||'';
          var pm=btn.getAttribute('data-pm')||'';
          var loc=btn.getAttribute('data-loc')||'';
          var box=byId('edit-'+rowId);
          if(!box) return;

          box.innerHTML=
            '<div class="space-y-3">'+
              '<div><label class="block text-sm font-semibold mb-1">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label><input type="date" id="ed-date-'+rowId+'" class="input" value="'+date+'" min="'+today+'"></div>'+
              '<div><label class="block text-sm font-semibold mb-1">‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤</label>'+
                '<div class="flex pill p-1">'+
                  '<button type="button" id="ed-full-'+rowId+'"  class="flex-1 py-2 rounded-xl '+(!isSplit?'bg-white/20':'')+'" data-action="toggle-full" data-id="'+rowId+'">‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô</button>'+
                  '<button type="button" id="ed-split-'+rowId+'" class="flex-1 py-2 rounded-xl '+(isSplit?'bg-white/20':'')+'" data-action="toggle-split" data-id="'+rowId+'">‡πÅ‡∏¢‡∏Å AM/PM</button>'+
                '</div>'+
              '</div>'+
              '<div id="ed-fullBox-'+rowId+'" class="'+(isSplit?'hidden':'')+'">'+
                '<label class="block text-sm font-semibold mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡∏ó‡∏±‡πâ‡∏á‡∏ß‡∏±‡∏ô)</label>'+
                '<input type="text" id="ed-fullLoc-'+rowId+'" class="input" value="'+(loc||am)+'">'+
              '</div>'+
              '<div id="ed-splitBox-'+rowId+'" class="'+(isSplit?'':'hidden')+' space-y-3">'+
                '<div><label class="block text-sm font-semibold mb-1">üåÖ AM</label><input type="text" id="ed-am-'+rowId+'" class="input" value="'+am+'"></div>'+
                '<div><label class="block text-sm font-semibold mb-1">üåÜ PM</label><input type="text" id="ed-pm-'+rowId+'" class="input" value="'+pm+'"></div>'+
              '</div>'+
              '<div class="flex flex-col sm:flex-row gap-3 pt-2">'+
                '<button type="button" class="btn flex-1 py-2" data-action="save" data-id="'+rowId+'">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>'+
                '<button type="button" class="bg-white/10 hover:bg-white/20 flex-1 py-2 rounded-xl" data-action="cancel" data-id="'+rowId+'">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>'+
                '<button type="button" class="flex-1 py-2 rounded-xl border border-red-400/40 bg-red-500/15 hover:bg-red-500/25" data-action="delete" data-rowid="'+rowId+'">‡∏•‡∏ö</button>'+
              '</div>'+
            '</div>';
          removeClass(box,'hidden');
          return;
        }

        var action = btn.getAttribute('data-action');
        if(!action) return;

        // toggle full/split
        if(action==='toggle-full' || action==='toggle-split'){
          var id = btn.getAttribute('data-id');
          var fullB=byId('ed-full-'+id), splitB=byId('ed-split-'+id);
          var fb=byId('ed-fullBox-'+id), sb=byId('ed-splitBox-'+id);
          var toSplit = (action==='toggle-split');
          if(toSplit){
            if(splitB) addClass(splitB,'bg-white/20'); if(fullB) removeClass(fullB,'bg-white/20');
            if(sb) removeClass(sb,'hidden'); if(fb) addClass(fb,'hidden');
          }else{
            if(fullB) addClass(fullB,'bg-white/20'); if(splitB) removeClass(splitB,'bg-white/20');
            if(fb) removeClass(fb,'hidden'); if(sb) addClass(sb,'hidden');
          }
          return;
        }

        // cancel edit
        if(action==='cancel'){
          var idc=btn.getAttribute('data-id'); var box2=byId('edit-'+idc); if(box2) addClass(box2,'hidden'); return;
        }

        // delete
        if(action==='delete'){
          var rowIdDel=btn.getAttribute('data-rowid');
          if(!confirm('‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?')) return;
          setBtnLoading(btn,true,'‡∏•‡∏ö','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...');
          callAPI('delete',{rowId:rowIdDel}, function(r){
            setBtnLoading(btn,false,'‡∏•‡∏ö');
            if(!r.ok) return toast(r.error||'‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
            toast('‡∏•‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
            var name=(byId('viewName')&&byId('viewName').value)||'';
            if(name) renderSchedule(name);
          });
          return;
        }

        // save
        if(action==='save'){
          var idS=btn.getAttribute('data-id');
          var dateS=byId('ed-date-'+idS).value;
          if(!dateS) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà','error');
          if(dateS<today) return toast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏±‡πâ‡∏á‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡πÑ‡∏î‡πâ','error');
          var isFull = !byId('ed-fullBox-'+idS).classList.contains('hidden');
          var payload={rowId:idS, date:dateS};
          if(isFull){
            var loc2=(byId('ed-fullLoc-'+idS).value||'').replace(/^\s+|\s+$/g,'');
            if(!loc2) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà (‡πÄ‡∏ï‡πá‡∏°‡∏ß‡∏±‡∏ô)','error');
            payload.split=false; payload.location=loc2;
          }else{
            var am2=(byId('ed-am-'+idS).value||'').replace(/^\s+|\s+$/g,'');
            var pm2=(byId('ed-pm-'+idS).value||'').replace(/^\s+|\s+$/g,'');
            if(!am2||!pm2) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ó‡∏±‡πâ‡∏á AM ‡πÅ‡∏•‡∏∞ PM','error');
            payload.split=true; payload.amLoc=am2; payload.pmLoc=pm2;
          }
          setBtnLoading(btn,true,'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
          callAPI('update',payload,function(r){
            setBtnLoading(btn,false,'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å');
            if(!r.ok) return toast(r.error||'‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
            openPopup('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß');
            var name2=(byId('viewName')&&byId('viewName').value)||'';
            if(name2) renderSchedule(name2);
          });
          return;
        }
      });
    }

    /* ===== Scheduler ===== */
    var weekdayWrap=byId('weekdayWrap'), labels=['‡∏≠‡∏≤','‡∏à','‡∏≠','‡∏û','‡∏û‡∏§','‡∏®','‡∏™'];
    var dayButtons=[];
    if(weekdayWrap){
      for(var di=0;di<7;di++){
        var b=document.createElement('button');
        b.type='button';
        b.className='px-2 py-2 rounded-lg bg-white/10 hover:bg-white/20';
        b.textContent=labels[di];
        b.setAttribute('data-active', (di>=1&&di<=5)?'1':'0');
        toggleDay(b);
        b.addEventListener('click', (function(bb){
          return function(){ bb.setAttribute('data-active', bb.getAttribute('data-active')==='1'?'0':'1'); toggleDay(bb); };
        })(b));
        weekdayWrap.appendChild(b);
        dayButtons.push(b);
      }
    }
    function toggleDay(b){
      if(b.getAttribute('data-active')==='1'){
        b.classList.add('bg-emerald-500/20','border','border-emerald-400/40');
      }else{
        b.classList.remove('bg-emerald-500/20','border','border-emerald-400/40');
      }
    }
    function isoToJs(d){ return (d%7); }
    function jsToIso(i){ return (i===0?7:i); }

    function loadSchedule(){
      callAPI('getSchedule',{}, function(r){
        if(!r.ok){ var st=byId('schedStatus'); if(st) st.textContent=r.error||'‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à'; return; }
        var cfg=r.config||{};
        var en=byId('schedEnabled'); if(en) en.checked=!!cfg.enabled;
        var tm=byId('schedTime'); if(tm) tm.value=cfg.time||'08:30';
        var sk=byId('schedSkipHolidays'); if(sk) sk.checked=!!cfg.skipHolidays;
        for(var i=0;i<dayButtons.length;i++){ dayButtons[i].setAttribute('data-active','0'); toggleDay(dayButtons[i]); }
        var days=cfg.days||[1,2,3,4,5];
        for(var j=0;j<days.length;j++){ var idx=isoToJs(days[j]); if(dayButtons[idx]){ dayButtons[idx].setAttribute('data-active','1'); toggleDay(dayButtons[idx]); } }
        var stEl=byId('schedStatus');
        if(stEl) stEl.textContent = cfg.enabled ? ('‡∏à‡∏∞‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏ó‡∏∏‡∏Å‡∏ß‡∏±‡∏ô‡πÄ‡∏ß‡∏•‡∏≤ '+(cfg.time||'')+' (‡∏ß‡∏±‡∏ô: '+days.join(',')+')') : '‡∏õ‡∏¥‡∏î‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡∏≠‡∏¢‡∏π‡πà';
      });
    }
    loadSchedule();
    var reloadBtn=byId('reloadSchedBtn'); if(reloadBtn){ reloadBtn.addEventListener('click', loadSchedule); }

    var saveSchedBtn=byId('saveSchedBtn');
    if(saveSchedBtn){
      saveSchedBtn.addEventListener('click', function(){
        var enabled=byId('schedEnabled').checked;
        var time=byId('schedTime').value;
        var skipHolidays=byId('schedSkipHolidays').checked;
        var days=[], i;
        for(i=0;i<dayButtons.length;i++){ if(dayButtons[i].getAttribute('data-active')==='1'){ days.push(jsToIso(i)); } }
        if(!/^\d{2}:\d{2}$/.test(time)) return toast('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (HH:mm)','error');
        if(enabled && !days.length) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ß‡∏±‡∏ô','error');
        setBtnLoading(saveSchedBtn,true,'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...');
        callAPI('saveSchedule',{enabled:enabled,time:time,days:days,skipHolidays:skipHolidays}, function(r){
          setBtnLoading(saveSchedBtn,false,'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á');
          if(!r.ok) return toast(r.error||'‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
          toast('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏™‡πà‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢'); loadSchedule();
        });
      });
    }

    var sendNowBtn=byId('sendNowBtn');
    if(sendNowBtn){
      sendNowBtn.addEventListener('click', function(){
        var date=byId('sendDateInput').value;
        if(!date) return toast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô','error');
        setBtnLoading(sendNowBtn,true,'‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ','‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á...');
        callAPI('pushNow',{date:date}, function(r){
          setBtnLoading(sendNowBtn,false,'‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ');
          if(!r.ok) return toast(r.error||'‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à','error');
          openPopup('‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏•‡∏ô‡πå‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢');
        });
      });
    }
  })();
  </script>
</body>
</html>
