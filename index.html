<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Check In Fin-ed</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --card-radius:1.5rem; --input-radius:.9rem; --input-padding-y:.9rem; --input-padding-x:1rem; --input-font-size:1.05rem; }
    body{ box-sizing:border-box; font-family:'Inter',system-ui,-apple-system,'Segoe UI',sans-serif }
    .glass{ background:rgba(255,255,255,.08); backdrop-filter:blur(20px); border:1px solid rgba(255,255,255,.12) }
    .card{ border-radius:var(--card-radius) }
    .input{ width:100%; background:rgba(255,255,255,.06); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,.15); color:#fff;
            padding:var(--input-padding-y) var(--input-padding-x); border-radius:var(--input-radius); font-size:var(--input-font-size) }
    .input:focus{ background:rgba(255,255,255,.1); border-color:rgba(255,255,255,.3); box-shadow:0 0 0 3px rgba(255,255,255,.08); outline:none }
    select.input option{ color:#111; background:#fff }
    .input[type="date"], .input[type="time"]{ -webkit-appearance:none; appearance:none; line-height:1.65 }
    .input[type="date"]::-webkit-datetime-edit{ padding:.35rem .5rem }
    .input[type="date"]::-webkit-datetime-edit-fields-wrapper{ padding:0 .25rem }
    .input[type="date"]::-webkit-datetime-edit-text{ padding:0 .2rem }
    .input[type="date"]::-webkit-calendar-picker-indicator, .input[type="time"]::-webkit-calendar-picker-indicator{ padding-right:.5rem; filter:invert(1) opacity(.85) }
    .btn{ background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); transition:.2s; border-radius:var(--input-radius) }
    .btn:hover{ background:rgba(255,255,255,.18); transform:translateY(-1px) }
    .btn-cta{ background:linear-gradient(135deg,#10b981,#16a34a); border:0; box-shadow:0 12px 24px rgba(16,185,129,.25) }
    .btn-cta:hover{ transform:translateY(-1.5px) scale(1.01); box-shadow:0 16px 30px rgba(16,185,129,.32) }
    .pill{ background:rgba(255,255,255,.1); border-radius:calc(var(--input-radius) + .4rem) }
    .chip{ background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.18) }
    .chip:hover{ background:rgba(255,255,255,.12) }
    .mini-btn{ background:rgba(255,255,255,.12); border:1px solid rgba(255,255,255,.25); border-radius:.7rem }
    .mini-btn:hover{ background:rgba(255,255,255,.18) }

    .tab-btn{ border:1px solid rgba(255,255,255,.18); background:rgba(255,255,255,.06) }
    .tab-btn[aria-selected="true"]{ background:rgba(16,185,129,.18); border-color:rgba(16,185,129,.4) }
    .tab-panel{ display:none } .tab-panel.active{ display:block }

    .btn-equal{ padding:var(--input-padding-y) var(--input-padding-x); border-radius:var(--input-radius) }
    .row-card{ border-radius:1rem; background:rgba(255,255,255,.05); border:1px solid rgba(255,255,255,.1) }

    /* Auth Lock */
    body.auth-locked { overflow: hidden; }
    @keyframes shake{10%,90%{transform:translateX(-1px)}20%,80%{transform:translateX(2px)}30%,50%,70%{transform:translateX(-4px)}40%,60%{transform:translateX(4px)}}
    .shake { animation: shake .35s linear both; }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-slate-900 via-gray-900 to-zinc-900 text-white auth-locked">
  <div id="authGate" class="fixed inset-0 z-[60] flex items-center justify-center p-6">
    <div class="absolute inset-0 bg-black/70 backdrop-blur-sm"></div>
    <div id="authCard" class="relative glass card w-full max-w-sm p-6">
      <div class="text-center mb-4">
        <div class="inline-flex items-center justify-center w-14 h-14 rounded-xl bg-white/10 border border-white/20 mb-3">
          <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 11c1.657 0 3-1.567 3-3.5S13.657 4 12 4 9 5.567 9 7.5 10.343 11 12 11zM19 21a7 7 0 00-14 0h14z"/></svg>
        </div>
        <h2 class="text-xl font-semibold">ใส่รหัสเพื่อเข้าใช้งาน</h2>
        <p class="text-white/70 text-sm mt-1">ระบบจะปลดล็อกเมื่อกรอกรหัสถูกต้อง</p>
      </div>
      <label class="block text-sm font-medium mb-2">รหัสผ่าน</label>
      <div class="flex gap-2">
        <input id="authInput" type="password" class="input flex-1" placeholder="ใส่รหัสผ่าน"/>
        <button id="authToggle" type="button" class="btn px-3">แสดง</button>
      </div>
      <p id="authError" class="text-red-300 text-sm mt-2 hidden">รหัสผ่านไม่ถูกต้อง</p>
      <button id="authBtn" type="button" class="btn btn-cta w-full py-3 font-semibold mt-4">เข้าสู่ระบบ</button>
      <p class="text-xs text-white/60 mt-3">* จะจำสถานะปลดล็อกเฉพาะแท็บนี้จนกว่าจะปิดแท็บ</p>
    </div>
  </div>

  <div class="fixed inset-0 pointer-events-none">
    <div class="absolute -top-40 -right-40 w-80 h-80 rounded-full blur-3xl bg-white/10"></div>
    <div class="absolute -bottom-40 -left-40 w-80 h-80 rounded-full blur-3xl bg-white/10"></div>
  </div>

  <div class="relative z-10 container mx-auto max-w-4xl px-6 py-10">
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-white/10 border border-white/20 mb-5">
        <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
      </div>
      <h1 class="text-3xl font-bold tracking-tight">Check In Fin-ed</h1>
    </div>

    <div class="glass card p-2 mb-6">
      <div role="tablist" class="grid grid-cols-1 sm:grid-cols-3 gap-2">
        <button id="tab-1" type="button" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="true">Check In</button>
        <button id="tab-2" type="button" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="false">ตารางงานในอนาคต</button>
        <button id="tab-3" type="button" role="tab" class="tab-btn rounded-xl py-3 font-semibold" aria-selected="false">ตั้งเวลา Check-in</button>
      </div>
    </div>
    
    <div id="panel-1" class="tab-panel active">
      </div>
    <div id="panel-2" class="tab-panel">
      </div>
    <div id="panel-3" class="tab-panel">
      </div>

    <div id="status" class="hidden mt-6 p-4 rounded-2xl"></div>
    <div id="popup" class="hidden fixed inset-0 z-50 items-center justify-center p-6">
      <div class="absolute inset-0 bg-black/50"></div>
      <div class="relative glass card p-6 max-w-sm w-full text-center">
        <div class="w-14 h-14 rounded-2xl bg-green-500/20 mx-auto mb-4 flex items-center justify-center">
          <svg class="w-8 h-8 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
        </div>
        <h3 class="text-xl font-semibold mb-2">สำเร็จ</h3>
        <p id="popupMsg" class="text-white/90 mb-4"></p>
        <button id="popupOk" type="button" class="btn w-full py-2 font-semibold">ตกลง</button>
      </div>
    </div>
  </div>

  <script>
  window.addEventListener('DOMContentLoaded', () => {
    /* ========== AUTH ========== */
    // WARNING: Storing passwords client-side is very insecure.
    const PASSWORD = 'start2558';
    const AUTH_KEY = 'auth_ok';

    (function initAuthGate(){
      const saved = sessionStorage.getItem(AUTH_KEY);
      if(saved === '1'){ unlockApp(true); return; }
      setTimeout(()=>document.getElementById('authInput')?.focus(), 30);
    })();

    function unlockApp(silent=false){
      document.body.classList.remove('auth-locked');
      const gate = document.getElementById('authGate');
      if(gate){
        gate.remove();
      }
      sessionStorage.setItem(AUTH_KEY,'1');
      if(!silent) document.querySelector('h1')?.scrollIntoView({behavior:'smooth', block:'start'});
    }
    function shakeCard(){
      const card=document.getElementById('authCard');
      const err=document.getElementById('authError');
      err?.classList.remove('hidden');
      if(!card) return; card.classList.remove('shake'); void card.offsetWidth; card.classList.add('shake');
    }
    function tryAuth(){
      const v=(document.getElementById('authInput').value||'').trim();
      if(v===PASSWORD){ document.getElementById('authError').classList.add('hidden'); unlockApp(); }
      else{ shakeCard(); }
    }
    
    document.getElementById('authBtn').addEventListener('click',tryAuth);
    document.getElementById('authInput').addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); tryAuth(); }});
    document.getElementById('authToggle').addEventListener('click',()=>{
      const i=document.getElementById('authInput'); if(!i) return;
      i.type=i.type==='password'?'text':'password';
      document.getElementById('authToggle').textContent=i.type==='password'?'แสดง':'ซ่อน';
      i.focus(); i.selectionStart=i.value.length; i.selectionEnd=i.value.length;
    });

    /* ========== POPUP HELPERS ========== */
    function openPopup(text){
      document.getElementById('popupMsg').textContent=text;
      const p=document.getElementById('popup');
      p.classList.remove('hidden'); p.classList.add('flex');
    }
    function closePopup(){
      const p=document.getElementById('popup');
      p.classList.add('hidden'); p.classList.remove('flex');
    }
    window.closePopup = closePopup;
    document.getElementById('popupOk').addEventListener('click', closePopup);

    function escapeHTML(s){ return (s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') }

    /* ========== UTILS & TABS ========== */
    const APP_SCRIPT_WEBAPP_URL='https://script.google.com/macros/s/AKfycbxKmlulJgGnv8pUqbbOYlK5mRn6jZ_DdQQCKoJ3dExHWl62mDOPhDR5usWbSpC38gzH/exec';
    const toLocalISO=d=>`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    function getWeekRange(offset=0){
      const now=new Date(); now.setHours(0,0,0,0);
      const diffToMon=(now.getDay()===0?-6:1-now.getDay())+offset*7;
      const mon=new Date(now); mon.setDate(now.getDate()+diffToMon);
      const fri=new Date(mon); fri.setDate(mon.getDate()+4);
      return {start:toLocalISO(mon),end:toLocalISO(fri)};
    }
    
    const tabs=[{btn:'tab-1',panel:'panel-1'},{btn:'tab-2',panel:'panel-2'},{btn:'tab-3',panel:'panel-3'}];
    function activateTab(i){
      tabs.forEach((t,idx)=>{
        const btn = document.getElementById(t.btn);
        const panel = document.getElementById(t.panel);
        if (btn) btn.setAttribute('aria-selected',i===idx?'true':'false');
        if (panel) panel.classList.toggle('active',i===idx);
      });
      localStorage.setItem('activeTab',String(i));
    }
    tabs.forEach((t,i)=>document.getElementById(t.btn)?.addEventListener('click',()=>activateTab(i)));
    const savedTab=Number(localStorage.getItem('activeTab'));
    if(!Number.isNaN(savedTab) && savedTab >= 0 && savedTab < tabs.length) {
        activateTab(savedTab);
    } else {
        activateTab(0);
    }
    
    const today=toLocalISO(new Date());
    // The following lines need the corresponding HTML elements to exist on the page.
    // Make sure you have inputs with these IDs in your tab panels.
    const dateInput=document.getElementById('dateInput');
    if (dateInput) { dateInput.min=today; dateInput.value=today; }
    const rangeStart=document.getElementById('rangeStart');
    if (rangeStart) rangeStart.min=today;
    const rangeEnd=document.getElementById('rangeEnd');
    if (rangeEnd) rangeEnd.min=today;
    const sendDateInput=document.getElementById('sendDateInput');
    if (sendDateInput) { sendDateInput.min=today; sendDateInput.value=today; }

    function toast(msg,type='info'){
        const el=document.getElementById('status');
        if (!el) return;
        el.className=`mt-6 p-4 rounded-2xl ${type==='error'?'bg-red-500/20 border border-red-500/40':'bg-white/10 border border-white/20'}`;
        el.textContent=msg; el.classList.remove('hidden'); setTimeout(()=>el.classList.add('hidden'),4500);
    }
    function setBtnLoading(btn,loading,done='เสร็จ',label='กำลังทำงาน...'){
        if (!btn) return;
        if(loading){
            btn.disabled=true; btn.dataset.prev=btn.innerHTML;
            btn.innerHTML=`<span class="inline-flex items-center gap-2"><svg class="w-5 h-5 animate-spin" viewBox="0 0 24 24" fill="none"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path></svg>${label}</span>`;
        } else {
            btn.disabled=false; btn.innerHTML=btn.dataset.prev||done;
        }
    }

    async function callAPI(action,payload={}){
        const fd=new FormData();
        fd.append('action',action);
        fd.append('payload',JSON.stringify(payload));
        const res=await fetch(APP_SCRIPT_WEBAPP_URL,{method:'POST',body:fd});
        const t=await res.text();
        try{ return JSON.parse(t) }catch{ return {ok:false,error:'Invalid JSON',raw:t} }
    }
    
    /* ========== MAIN APP LOGIC (Check-in, Bulk, View, Edit, etc.) ========== */
    // Note: All the following code assumes the relevant HTML elements exist in your tab panels.
    
    // Check-in Form Logic
    const checkinBtn=document.getElementById('checkinBtn');
    const checkinForm=document.getElementById('checkinForm');
    if(checkinForm) {
      checkinForm.addEventListener('submit',async e=>{
        e.preventDefault();
        const name=document.getElementById('nameSelect').value.trim();
        const date=document.getElementById('dateInput').value;
        if(!name||!date) return toast('กรุณากรอกข้อมูลให้ครบถ้วน','error');
        if(date<today)   return toast('ไม่อนุญาตให้บันทึกย้อนหลัง','error');
        let payload;
        const splitMode = !document.getElementById('fullBox')?.classList.contains('hidden');
        if(!splitMode){
          const loc=document.getElementById('fullLocation').value.trim();
          if(!loc) return toast('กรุณากรอกสถานที่ (เต็มวัน)','error');
          payload={name,date,split:false,location:loc};
        }else{
          const am=document.getElementById('amLocation').value.trim(), pm=document.getElementById('pmLocation').value.trim();
          if(!am||!pm) return toast('กรุณากรอกสถานที่ทั้ง AM และ PM','error');
          payload={name,date,split:true,amLoc:am,pmLoc:pm};
        }
        try{
          setBtnLoading(checkinBtn,true,'Check In','กำลังบันทึก...');
          const {ok,upsert,error}=await callAPI('create',payload);
          if(!ok) return toast(error||'บันทึกไม่สำเร็จ','error');
          openPopup(upsert?'อัปเดตข้อมูลของวันนี้เรียบร้อย':'บันทึกเรียบร้อย');
          if (typeof refreshSuggestions === 'function') refreshSuggestions();
        } finally { setBtnLoading(checkinBtn,false,'Check In') }
      });
    }

    // Bulk Create Logic
    const bulkThisWeekBtn=document.getElementById('bulkThisWeek');
    if (bulkThisWeekBtn) {
      bulkThisWeekBtn.addEventListener('click',async()=>{
        const base=commonBulk(); if(!base) return;
        const {start,end}=getWeekRange(0);
        const payload={...base,startDate:start,endDate:end,weekdaysOnly:true};
        try{
          setBtnLoading(bulkThisWeekBtn,true,'สร้าง จ–ศ สัปดาห์นี้','กำลังสร้าง...');
          const r=await callAPI('bulkCreate',payload);
          if(!r.ok) return toast(r.error||'บันทึกไม่สำเร็จ','error');
          const msg='สร้างสำเร็จ: เพิ่ม '+r.created+' · อัปเดต '+r.updated+(r.skippedPast?(' · ข้ามย้อนหลัง '+r.skippedPast):'');
          openPopup(msg);
        } finally { setBtnLoading(bulkThisWeekBtn,false,'สร้าง จ–ศ สัปดาห์นี้') }
      });
    }
    
    // ... (Add other event listeners for bulkNextWeekBtn, bulkRangeBtn, etc. in a similar safe way)
    
  });
  </script>
</body>
</html>
